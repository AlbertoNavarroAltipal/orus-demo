# "org" ensures this Service is used with the correct Serverless Framework License Key.
org: engynex
# "service" is the name of this project. This will also be added to your AWS resource names.
service: orus-demo

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

provider:
  name: aws
  runtime: nodejs20.x
  httpApi:
    cors: true
  # Uncomment to easily set up a custom domain. Read the docs for more details:
  # https://www.serverless.com/framework/docs/providers/aws/guide/domains
  # domain: api.example.com
  environment:
    PGHOST: ${env:PGHOST, 'localhost'}
    PGPORT: ${env:PGPORT, '5432'}
    PGDATABASE: ${env:PGDATABASE, 'postgres'}
  PGUSER: ${env:PGUSER, 'postgres'}
  PGPASSWORD: ${env:PGPASSWORD, 'postgres'}
  PGSSL: ${env:PGSSL, 'true'}
  PGPOOL_MAX: ${env:PGPOOL_MAX, '5'}

functions:
  hello:
    handler: handler.hello
    description: "Lambda de ejemplo para pruebas."
    events:
      - httpApi:
          path: /
          method: get
  # =========================
  # IAM - Permissions
  # =========================
  iam-permissions-list:
    handler: src/lambda/permissions/list.handler
    description: "Lista todos los permisos disponibles."
    events:
      - httpApi:
          path: /iam/permissions
          method: get
  iam-permissions-get:
    handler: src/lambda/permissions/get.handler
    description: "Obtiene la información de un permiso específico."
    events:
      - httpApi:
          path: /iam/permissions/{code}
          method: get
  iam-permissions-create:
    handler: src/lambda/permissions/create.handler
    description: "Crea un nuevo permiso."
    events:
      - httpApi:
          path: /iam/permissions
          method: post
  iam-permissions-update:
    handler: src/lambda/permissions/update.handler
    description: "Actualiza los datos de un permiso existente."
    events:
      - httpApi:
          path: /iam/permissions/{code}
          method: put
  iam-permissions-delete:
    handler: src/lambda/permissions/delete.handler
    description: "Elimina un permiso por código."
    events:
      - httpApi:
          path: /iam/permissions/{code}
          method: delete

  # =========================
  # IAM - Roles
  # =========================
  iam-roles-list:
    handler: src/lambda/roles/list.handler
    description: "Lista todos los roles disponibles."
    events:
      - httpApi:
          path: /iam/roles
          method: get
  iam-roles-get:
    handler: src/lambda/roles/get.handler
    description: "Obtiene la información de un rol específico."
    events:
      - httpApi:
          path: /iam/roles/{code}
          method: get
  iam-roles-create:
    handler: src/lambda/roles/create.handler
    description: "Crea un nuevo rol."
    events:
      - httpApi:
          path: /iam/roles
          method: post
  iam-roles-update:
    handler: src/lambda/roles/update.handler
    description: "Actualiza los datos de un rol existente."
    events:
      - httpApi:
          path: /iam/roles/{code}
          method: put
  iam-roles-delete:
    handler: src/lambda/roles/delete.handler
    description: "Elimina un rol por código."
    events:
      - httpApi:
          path: /iam/roles/{code}
          method: delete

  # Role <-> Permission mappings
  iam-roles-permissions-list:
    handler: src/lambda/roles/permissions-list.handler
    description: "Lista los permisos asociados a un rol."
    events:
      - httpApi:
          path: /iam/roles/{code}/permissions
          method: get
  iam-roles-permissions-attach:
    handler: src/lambda/roles/permissions-attach.handler
    description: "Asocia un permiso a un rol."
    events:
      - httpApi:
          path: /iam/roles/{code}/permissions/{permissionCode}
          method: post
  iam-roles-permissions-detach:
    handler: src/lambda/roles/permissions-detach.handler
    description: "Desasocia un permiso de un rol."
    events:
      - httpApi:
          path: /iam/roles/{code}/permissions/{permissionCode}
          method: delete

  # =========================
  # IAM - Users
  # =========================
  iam-users-assign-role:
    handler: src/lambda/users/assign-role.handler
    description: "Asigna un rol a un usuario."
    events:
      - httpApi:
          path: /iam/users/{email}/roles/{roleCode}
          method: post
  iam-users-remove-role:
    handler: src/lambda/users/remove-role.handler
    description: "Remueve un rol de un usuario."
    events:
      - httpApi:
          path: /iam/users/{email}/roles/{roleCode}
          method: delete
  iam-users-assign-permission:
    handler: src/lambda/users/assign-permission.handler
    description: "Asigna un permiso a un usuario."
    events:
      - httpApi:
          path: /iam/users/{email}/permissions/{permissionCode}
          method: post
  iam-users-remove-permission:
    handler: src/lambda/users/remove-permission.handler
    description: "Remueve un permiso de un usuario."
    events:
      - httpApi:
          path: /iam/users/{email}/permissions/{permissionCode}
          method: delete
